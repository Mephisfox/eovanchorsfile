<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冷山调查局 · 心锚规划仪 v9.0</title>
    <style>
        /* =========================================
           [MODULE: CORE VARIABLES]
           ========================================= */
        :root {
            --paper-bg: #dcd0c0;
            --card-bg: #f5f0e6;
            --ink-black: #1a1a1a;
            
            /* 原始复古色 */
            --retro-red: #a34d44;
            --retro-blue: #4a7690;
            --retro-green: #528563;
            --retro-gold: #b08d50;
            
            /* 新增细分印章色 */
            --retro-dark-red: #8b3a30;    /* 暗红色：总控/幻影 */
            --retro-dark-green: #3e5c47;  /* 暗绿色：废弃/阈限 */
            --retro-bright-red: #d33f33;  /* 鲜红色：活动/氪金/皮肤 */

            --border-width: 2px;
            --anchor-height: 75px;

            --roughness-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--paper-bg);
            background-image: radial-gradient(rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 15px 15px;
            color: var(--ink-black);
            margin: 0; padding: 15px;
            display: flex; justify-content: center;
        }

        /* 拉宽截图区以容纳同行的多个特性标签 */
        #captureArea { width: 100%; max-width: 900px; box-sizing: border-box; }
        header { text-align: center; border-bottom: 2px solid var(--ink-black); margin-bottom: 20px; padding-bottom: 10px; }
        h1 { margin: 0; font-family: 'Georgia', serif; letter-spacing: 2px; font-size: 1.8rem; }

        .card-flow { display: flex; flex-direction: column; gap: 15px; }

        .flow-card { background: var(--card-bg); border: var(--border-width) solid var(--ink-black); position: relative; }

        .char-header {
            padding: 8px 20px; background: #c8bdad; border-bottom: var(--border-width) solid var(--ink-black);
            display: flex; justify-content: space-between; align-items: center;
        }
        .char-info { display: flex; align-items: center; gap: 12px; }
        .char-avatar { 
            width: 40px; height: 40px; background: var(--ink-black); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 900; font-size: 1.2rem;
        }
        .char-name { font-weight: 900; font-size: 1.2rem; text-transform: uppercase; }
        
        .tag-container { display: flex; gap: 5px; align-items: center; }
        /* 修复标签垂直居中问题 */
        .char-tag { 
            font-size: 0.65rem; background: rgba(255,255,255,0.5); 
            padding: 0 6px; border: 1px solid var(--ink-black); border-radius: 4px; 
            display: inline-flex; align-items: center; justify-content: center;
            height: 18px; line-height: 1;
        }

        .build-section { padding: 0 15px 15px 15px; border-bottom: 1px dashed rgba(0,0,0,0.2); }
        .build-section:last-child { border-bottom: none; }
        .plan-header {
            display: inline-block; background: var(--ink-black); color: white;
            padding: 2px 10px; font-size: 0.8rem; font-weight: bold; margin: 12px 0 8px 0;
        }
        .slots-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* =========================================
           [MODULE: ANCHOR CARD]
           ========================================= */
        .anchor-slot {
            position: relative; height: var(--anchor-height); background: #fff;
            border: 2px solid var(--ink-black);
            overflow: hidden; display: flex; align-items: center; 
            padding-left: 85px; padding-right: 8px;
        }
        .anchor-slot.empty { justify-content: center; padding: 0; background: rgba(0,0,0,0.05); color: #999; font-size: 0.7rem; }

        .anchor-bg-wrapper {
            position: absolute; top: -5px; left: -20px; 
            width: 120px; height: 110%; z-index: 0;
            opacity: 0.7; mix-blend-mode: multiply; 
            -webkit-mask-image: var(--roughness-mask); mask-image: var(--roughness-mask);
            pointer-events: none;
        }
        .anchor-bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .layer-gray { filter: grayscale(1) contrast(1.2); z-index: 1; }
        .layer-desaturated {
            filter: saturate(0.6) contrast(1.1); z-index: 2;
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 30%, rgba(0,0,0,0) 80%);
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 30%, rgba(0,0,0,0) 80%);
        }

        .blueprint-frame {
            position: absolute; top: 10%; left: 5px; width: 75px; height: 80%;
            border: 1px solid var(--retro-blue); opacity: 0.3; z-index: 0;
        }

        .anchor-content { position: relative; z-index: 10; width: 100%; }
        .anchor-name { 
            font-weight: 900; font-size: 0.85rem; display: block; color: var(--ink-black); 
            position: relative; padding-bottom: 4px; margin-bottom: 4px; 
        }
        .anchor-name::after {
            content: ""; position: absolute; left: -85px; right: -10px; bottom: 0;
            height: 1px; background: rgba(0,0,0,0.2);
        }
        
        .skill-container { display: flex; flex-wrap: wrap; gap: 4px; }
        .anchor-skill {
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: bold; color: #333; height: 16px; line-height: 1;
            background: rgba(255, 255, 255, 0.7); border: 1px solid #ccc; border-radius: 3px; padding: 0 5px;
        }
        
        .rand-skill-btn { border: 1px dashed var(--ink-black); opacity: 0.6; cursor: pointer; transition: 0.2s; }
        .rand-skill-btn:hover { opacity: 1; background: #fff; }
        .rand-skill-selected { border: 1px solid var(--retro-blue); color: var(--retro-blue); cursor: pointer; }
        .rand-skill-selected:hover { background: rgba(74, 118, 144, 0.1); }

        .anchor-stamp {
            position: absolute; top: 3px; right: 3px; font-size: 0.55rem; font-weight: 900;
            color: var(--ink-black); border: 1.5px solid currentColor; padding: 1px 3px; 
            transform: rotate(-8deg); z-index: 11; background: rgba(255,255,255,0.8);
        }
        
        /* 来源地印章颜色细分 */
        /* 绿色：混合体、奇点列车、洛伦佐、乐园梦魇 */
        .anchor-slot[data-src*="混合体"] .anchor-stamp,
        .anchor-slot[data-src*="奇点列车"] .anchor-stamp,
        .anchor-slot[data-src*="洛伦佐"] .anchor-stamp,
        .anchor-slot[data-src*="乐园梦魇"] .anchor-stamp { color: var(--retro-green); border-color: var(--retro-green); }

        /* 暗红色：总控一号、幻影人偶 */
        .anchor-slot[data-src*="总控一号"] .anchor-stamp,
        .anchor-slot[data-src*="幻影人偶"] .anchor-stamp { color: var(--retro-dark-red); border-color: var(--retro-dark-red); }

        /* 暗绿色：废弃枢纽维度、阈限禁区商店 */
        .anchor-slot[data-src*="废弃枢纽"] .anchor-stamp,
        .anchor-slot[data-src*="阈限禁区"] .anchor-stamp { color: var(--retro-dark-green); border-color: var(--retro-dark-green); }

        /* 鲜红色：活动复刻、奥兹曼皮肤、充值回馈、大月卡商店 */
        .anchor-slot[data-src*="活动复刻"] .anchor-stamp,
        .anchor-slot[data-src*="奥兹曼皮肤"] .anchor-stamp,
        .anchor-slot[data-src*="充值回馈"] .anchor-stamp,
        .anchor-slot[data-src*="大月卡"] .anchor-stamp { color: var(--retro-bright-red); border-color: var(--retro-bright-red); }


        .action-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            margin-top: 20px; padding-top: 15px; border-top: 2px dashed rgba(0,0,0,0.2);
        }
        .retro-btn { 
            padding: 12px; font-weight: bold; cursor: pointer; border: 2px solid var(--ink-black); 
            box-shadow: 3px 3px 0 var(--ink-black); font-size: 1rem; font-family: inherit;
        }
        .retro-btn:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 var(--ink-black); }
        .btn-add { background: var(--card-bg); }
        .btn-calc { background: var(--ink-black); color: white; }

        #resultContainer { display: none; margin-top: 25px; }
        #resultContainer.active { display: block; }
        .briefing-card { background: #fffdf0; padding: 20px; }
        .briefing-header { 
            border-bottom: 2px solid var(--ink-black); margin-bottom: 15px; padding-bottom: 10px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .top-secret { font-size: 1.1rem; border: 2.5px solid var(--retro-red); color: var(--retro-red); padding: 3px 8px; font-weight: 900; transform: rotate(-3deg); }

        .dungeon-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #ccc; }
        .dungeon-left { display: flex; align-items: center; gap: 10px; }
        .dungeon-raw-img { width: 35px; height: 35px; object-fit: contain; }
        .dungeon-name { font-weight: bold; font-size: 1rem; }
        
        .dungeon-items { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
        .mini-anchor-icon {
            width: 32px; height: 32px; border-radius: 50%;
            background-size: cover; background-position: center; border: 1px solid #666; position: relative;
        }
        .mini-anchor-count {
            position: absolute; bottom: -3px; right: -3px;
            background: var(--retro-red); color: white; font-size: 8px; padding: 1px 3px; border-radius: 3px;
        }

        /* [MODALS] */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.open { display: flex; }
        
        .modal-file {
            background: var(--paper-bg); width: 90%; max-width: 650px; height: 85vh;
            border: 3px solid var(--ink-black); display: flex; flex-direction: column;
        }
        .modal-header, .modal-footer { padding: 10px 20px; background: #b8bdad; border-bottom: 2px solid var(--ink-black); }
        .modal-footer { border-top: 2px solid var(--ink-black); border-bottom: none; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        
        input, select { width: 100%; padding: 8px; font-family: inherit; border: 2px solid var(--ink-black); background: white; margin-bottom: 12px; box-sizing: border-box; }
        .tags-input-area { display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; border: 2px solid var(--ink-black); background: white; margin-bottom: 12px; }
        .tag-chip { background: #eee; padding: 2px 6px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; cursor: pointer; border: 1px solid #999; }
        .modal-plan-block { border: 2px dashed #aaa; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.4); }
        .chip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 5px; margin-bottom: 8px; }
        .chip { border: 1px solid #888; background: white; padding: 5px; font-size: 0.7rem; text-align: center; cursor: pointer; }
        .chip.selected { background: var(--ink-black); color: white; border-color: var(--retro-red); }
        .chip.dimmed { opacity: 0.2; pointer-events: none; }

        /* [MINI MODAL] */
        .mini-modal {
            background: var(--card-bg); width: 90%; max-width: 350px; height: auto;
            border: 2px solid var(--ink-black); box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        .mini-btn {
            background: white; border: 1px solid var(--ink-black); padding: 6px 10px;
            font-size: 0.8rem; font-weight: bold; cursor: pointer; text-align: center;
        }
        .mini-btn:hover { background: var(--ink-black); color: white; }
    </style>
</head>
<body>

    <div id="captureArea">
        <header>
            <h1>Anchors File</h1>
            <div class="subtitle">贝拉斯科家族提供</div>
        </header>

        <div class="card-flow" id="characterContainer"></div>

        <div id="resultContainer">
            <div class="flow-card briefing-card">
                <div class="briefing-header">
                    <span style="font-size:1.2rem; font-weight:900;">MISSION BRIEFING</span>
                    <span class="top-secret">TOP SECRET</span>
                </div>
                <div id="briefingContent"></div>
            </div>
        </div>
        
        <div class="action-area" id="actionArea">
            <button class="retro-btn btn-add" onclick="App.openNewFileModal()">+ NEW FILE</button>
            <button class="retro-btn btn-calc" onclick="App.generateReport()">ANALYZE</button>
        </div>
    </div>

    <div class="modal-overlay" id="editorModal">
        <div class="modal-file">
            <div class="modal-header"><h2 style="margin:0; font-size:1.2rem;">CREATE AGENT</h2></div>
            <div class="modal-body">
                <label style="font-size:0.8rem; font-weight:bold;">NAME</label>
                <input type="text" id="inputName" placeholder="如: 爱丽儿">

                <label style="font-size:0.8rem; font-weight:bold;">TAGS & CLASS (输入 突击手/狙击手/异能者/战术员/刀锋/盾卫 可筛选心锚)</label>
                <div class="tags-input-area" id="tagsContainer">
                    <input type="text" id="tagInput" placeholder="输入标签按回车..." style="border:none; margin:0; flex:1; height:30px;" onkeydown="UI.handleTagInput(event)">
                </div>

                <label style="font-size:0.8rem; font-weight:bold;">BUILDS COUNT</label>
                <select id="inputBuildCount" onchange="UI.updateModalBuildBlocks()">
                    <option value="1">1 套配装</option>
                    <option value="2">2 套配装</option>
                    <option value="3">3 套配装</option>
                </select>

                <div id="modalBuildsContainer"></div>
            </div>
            <div class="modal-footer">
                <button class="retro-btn" style="width:100%; background:var(--retro-red); color:white; border:none; box-shadow:none;" onclick="App.saveCharacter()">SAVE</button>
                <div style="text-align:center; margin-top:8px; cursor:pointer; font-size:0.8rem; text-decoration:underline" onclick="App.closeModal()">CANCEL</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="randSkillModal">
        <div class="mini-modal">
            <div class="modal-header" style="background:#e8e0d0; padding:10px;">
                <h3 style="margin:0; font-size:0.9rem;">特性配置 - <span id="randModalAnchorName"></span></h3>
            </div>
            <div class="modal-body" style="padding:15px; background:var(--card-bg);">
                <div style="font-size:0.75rem; font-weight:bold; color:#666; margin-bottom:5px;">固定特性 (基础能力)</div>
                <div id="randModalFixed" class="anchor-skill" style="margin-bottom:15px;"></div>
                
                <div style="font-size:0.75rem; font-weight:bold; color:#666; margin-bottom:5px;">随机特性 (点击配置)</div>
                <div id="randModalOptions" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
            <div class="modal-footer" style="background:#e8e0d0; padding:10px; text-align:center;">
                <span style="cursor:pointer; font-size:0.8rem; text-decoration:underline; font-weight:bold;" onclick="document.getElementById('randSkillModal').classList.remove('open')">关闭 (CLOSE)</span>
            </div>
        </div>
    </div>

<script>
// --- [MODULE 1] DATA ---
const DB = {
    anchors: {
        "偶像": [
            {name:"指挥官棋子", src:"混合体III", prof:"通用", fixed:"冲刺Lv2", random:[]},
            {name:"头狼金雕", src:"奇点列车III", prof:"狙击手/突击手", fixed:"惯性冲击Lv2", random:["集中Lv1", "巨人杀手Lv1"]},
            {name:"老鹰金雕", src:"奇点列车III", prof:"异能者/战术员", fixed:"掩护洞察Lv2", random:["强能Lv1", "挑战心Lv1"]},
            {name:"狮王金雕", src:"奇点列车III", prof:"刀锋/盾卫", fixed:"蓄势待发Lv2", random:["怨恨Lv1", "压制Lv1"]},
            {name:"冰雕王座", src:"总控一号II", prof:"异能者/战术员", fixed:"冲刺Lv2", random:["集中Lv1", "掩护洞察Lv1"]},
            {name:"无眠舞者", src:"总控一号II", prof:"异能者/战术员", fixed:"冲刺Lv2", random:["强能Lv1", "惯性冲击Lv1"]},
            {name:"优秀员工奖", src:"幻影人偶II", prof:"盾卫/战术员", fixed:"掩护洞察Lv2", random:["趋光Lv1", "同理心Lv1"]},
            {name:"钟楼卫兵", src:"幻影人偶II", prof:"刀锋/异能者", fixed:"蓄势待发Lv2", random:["挣扎Lv1", "同理心Lv1"]},
            {name:"伊甸雕塑", src:"阈限禁区商店获取", prof:"战术员/狙击手", fixed:"嫉妒心Lv2", random:["充盈Lv1", "灵泉Lv1", "有偿馈赠Lv1"]},
            {name:"谎言人偶", src:"阈限禁区商店获取", prof:"刀锋/突击手", fixed:"虚饰灵魂Lv2", random:["嫉妒心Lv1", "蓄势待发Lv1", "碰撞电离Lv1"]},
            {name:"灵渡伴侣", src:"大月卡商店获取", prof:"突击手/狙击手", fixed:"嫉妒心Lv2 + 充盈Lv1", random:[]},
            {name:"金牛雕像", src:"活动复刻获取", prof:"盾卫/异能者", fixed:"蓄势待发Lv2 + 冲刺Lv1", random:[]},
            {name:"鎏金奖杯", src:"奥兹曼皮肤“闲骑假日”获取", prof:"盾卫", fixed:"嫉妒心Lv2 + 挑战心Lv1", random:[]}
        ],
        "图籍": [
            {name:"爱伦的葬礼", src:"混合体III", prof:"通用", fixed:"畸变应对Lv2", random:[]},
            {name:"占星起源", src:"洛伦佐III", prof:"狙击手/突击手", fixed:"能量吸收Lv2", random:["下风Lv1", "破绽百出Lv1"]},
            {name:"终极魔术", src:"洛伦佐III", prof:"异能者/战术员", fixed:"紧急处理Lv2", random:["调和Lv1", "战地医护Lv1"]},
            {name:"秘典原本", src:"洛伦佐III", prof:"盾卫/刀锋", fixed:"象位遮蔽Lv2", random:["反击抽取Lv1", "优劣转换Lv1"]},
            {name:"美味佳肴", src:"总控一号II", prof:"狙击手/突击手", fixed:"怨恨Lv2", random:["炽焰Lv1", "破绽百出Lv1"]},
            {name:"海神文录", src:"总控一号II", prof:"异能者/战术员", fixed:"压制Lv2", random:["调和Lv1", "定点爆破Lv1"]},
            {name:"猫咪日记", src:"幻影人偶II", prof:"刀锋/异能者", fixed:"溯源冲击Lv2", random:["挣扎Lv1", "定点爆破Lv1", "紧急处理Lv1"]},
            {name:"一万个问题", src:"幻影人偶II", prof:"盾卫/战术员", fixed:"溯源冲击Lv2", random:["趋光Lv1", "畸变应对Lv1", "象位遮蔽Lv1"]},
            {name:"魔王组曲", src:"废弃枢纽维度I", prof:"突击手/狙击手", fixed:"招架Lv2", random:["充盈Lv1", "挑战心Lv1", "巨人杀手Lv1"]},
            {name:"贤人手迹", src:"活动复刻获取", prof:"盾卫/刀锋", fixed:"忍耐Lv2 + 碰撞电离Lv1", random:[]},
            {name:"乐园宣传册", src:"阈限禁区商店获取", prof:"刀锋/盾卫", fixed:"忍耐Lv2", random:["挣扎Lv1", "炽焰Lv1", "碰撞电离Lv1"]},
            {name:"度假指南", src:"阈限禁区商店获取", prof:"突击手/战术员", fixed:"假期美梦Lv2", random:["调和Lv1", "碰撞电离Lv1", "破绽百出Lv1"]}
        ],
        "钥匙": [
            {name:"主管密钥", src:"混合体III", prof:"通用", fixed:"冲破Lv2", random:[]},
            {name:"精雕绿钻钥匙", src:"乐园梦魇III", prof:"狙击手/突击手", fixed:"鹰眼Lv2", random:["集中Lv1", "下风Lv1", "破绽百出Lv1", "巨人杀手Lv1"]},
            {name:"精雕蓝钻钥匙", src:"乐园梦魇III", prof:"异能者/战术员", fixed:"鼓劲Lv2", random:["调和Lv1", "强能Lv1", "挑战心Lv1", "战地医护Lv1"]},
            {name:"精雕红钻钥匙", src:"乐园梦魇III", prof:"盾卫/刀锋", fixed:"好胜心Lv2", random:["怨恨Lv1", "压制Lv1", "优劣转换Lv1", "反击抽取Lv1"]},
            {name:"隐秘花园钥匙", src:"总控一号II", prof:"狙击手/突击手", fixed:"溯源冲击Lv2", random:["炽焰Lv1", "掩护洞察Lv1", "破绽百出Lv1"]},
            {name:"奥秘之眼", src:"总控一号II", prof:"异能者/战术员", fixed:"溯源冲击Lv2", random:["调和Lv1", "惯性冲击Lv1", "定点爆破Lv1"]},
            {name:"剑石之钥", src:"幻影人偶II", prof:"盾卫/战术员", fixed:"主场作战Lv2", random:["挑战心Lv1", "同理心Lv1", "战地医护Lv1"]},
            {name:"齿轮密钥", src:"幻影人偶II", prof:"刀锋/异能者", fixed:"主场作战Lv2", random:["怨恨Lv1", "同理心Lv1", "好胜心Lv1"]},
            {name:"伊甸印记", src:"阈限禁区商店获取", prof:"战术员/狙击", fixed:"哀悯庇护Lv2", random:["充盈Lv1", "灵泉Lv1", "有偿馈赠Lv1"]},
            {name:"天文馆钥匙", src:"活动复刻获取", prof:"通用", fixed:"同理心Lv2 + 定点爆破Lv1", random:[]},
            {name:"禁闭公寓钥匙", src:"阈限禁区商店获取", prof:"突击手", fixed:"危险通行Lv2", random:["破绽百出Lv1", "有偿馈赠Lv1", "碰撞电离Lv1"]},
            {name:"天秤庇护之钥", src:"阈限禁区商店获取", prof:"盾卫/刀锋", fixed:"安全感Lv2", random:["好胜心Lv1", "嫉妒心Lv1", "危险通行Lv1"]},
            {name:"界外之钥", src:"第一期充值回馈活动获取", prof:"异能者/战术员", fixed:"鼓劲Lv2 + 强能Lv1", random:[]}
        ]
    }
};

const State = { characters: [], tempChar: { name: "", tags: [], filterProf: "ALL", builds: [] }, isBriefingMode: false };

const UI = {
    renderFlow: () => {
        const container = document.getElementById('characterContainer');
        container.innerHTML = '';
        State.characters.forEach(char => {
            const card = document.createElement('div');
            card.className = 'flow-card char-card';
            let buildsHtml = char.builds.map((build, bIdx) => `
                <div class="build-section">
                    <div class="plan-header">${build.name}</div>
                    <div class="slots-grid">
                        ${UI.renderSlot(build.items.idol, 'A. 偶像', char.id, bIdx, 'idol')}
                        ${UI.renderSlot(build.items.manual, 'B. 图籍', char.id, bIdx, 'manual')}
                        ${UI.renderSlot(build.items.key, 'C. 钥匙', char.id, bIdx, 'key')}
                    </div>
                </div>`).join('');
            const tagsHtml = char.tags.map(t => `<span class="char-tag">${t}</span>`).join('');
            card.innerHTML = `<div class="char-header">
                <div class="char-info">
                    <div class="char-avatar">${char.name.charAt(0)}</div>
                    <div><div class="char-name">${char.name}</div><div class="tag-container">${tagsHtml}</div></div>
                </div>
                <button onclick="App.deleteChar(${char.id})" style="border:none;background:none;color:var(--retro-red);cursor:pointer;font-weight:bold;">✖</button>
            </div>${buildsHtml}`;
            container.appendChild(card);
        });
    },

    renderSlot: (item, label, charId, bIdx, type) => {
        if (!item) return `<div class="anchor-slot empty">${label}</div>`;
        let srcTag = item.src.replace('获取','').replace('商店','');
        if(srcTag.length > 8) srcTag = srcTag.substring(0,9)+"..";
        const imgPath = `anchors/${item.name}.png`;
        
        let skillHtml = `<span class="anchor-skill">${item.fixed}</span>`;
        if (item.random && item.random.length > 0) {
            if (item.selectedRand) {
                skillHtml += `<span class="anchor-skill rand-skill-selected" onclick="App.openRandModal(${charId}, ${bIdx}, '${type}')">${item.selectedRand}</span>`;
            } else {
                skillHtml += `<span class="anchor-skill rand-skill-btn" onclick="App.openRandModal(${charId}, ${bIdx}, '${type}')">+ 点击配置</span>`;
            }
        }

        return `<div class="anchor-slot filled" data-src="${item.src}">
            <div class="blueprint-frame"></div>
            <div class="anchor-bg-wrapper">
                <div class="anchor-bg-layer layer-gray" style="background-image:url('${imgPath}')"></div>
                <div class="anchor-bg-layer layer-desaturated" style="background-image:url('${imgPath}')"></div>
            </div>
            <div class="anchor-content">
                <span class="anchor-name">${item.name}</span>
                <div class="skill-container">${skillHtml}</div>
            </div>
            <div class="anchor-stamp">${srcTag}</div>
        </div>`;
    },

    renderBriefing: (counts) => {
        const container = document.getElementById('briefingContent');
        container.innerHTML = '';
        const specialSources = ["商店", "皮肤", "回馈", "礼包", "活动复刻", "赠送"];
        const sortedEntries = Object.entries(counts).sort((a, b) => {
			// 1. 定义识别特殊来源（无图标）的关键词
			const specialKeywords = ["商店", "皮肤", "回馈", "礼包", "活动复刻", "赠送"];
			const isASpecial = specialKeywords.some(s => a[0].includes(s));
			const isBSpecial = specialKeywords.some(s => b[0].includes(s));
			
			// 2. 计算两组的总需求数量
			const sumA = a[1].reduce((s, i) => s + i.count, 0);
			const sumB = b[1].reduce((s, i) => s + i.count, 0);

			// 3. 优先级排序逻辑：
			// 情况 A：一个有图标，一个无图标 -> 有图标的永远在前
			if (!isASpecial && isBSpecial) return -1;
			if (isASpecial && !isBSpecial) return 1;

			// 情况 B：同为“有图标”或同为“无图标” -> 按数量降序排
			return sumB - sumA;
		});
        sortedEntries.forEach(([dungeon, items]) => {
            const itemsHtml = items.map(item => `<div class="mini-anchor-icon" style="background-image:url('anchors/${item.name}.png')">
                ${item.count > 1 ? `<div class="mini-anchor-count">x${item.count}</div>` : ''}</div>`).join('');
            const isSpecial = specialSources.some(s => dungeon.includes(s));
            let iconHtml = isSpecial ? `<div style="width:35px; text-align:center; font-weight:bold; color:var(--retro-gold)">★</div>` :
                `<img src="dungeons/${dungeon}.png" class="dungeon-raw-img" onerror="this.style.display='none'">`;
            container.innerHTML += `<div class="dungeon-row">
                <div class="dungeon-left">${iconHtml}<span class="dungeon-name">${dungeon}</span></div>
                <div class="dungeon-items">${itemsHtml}</div>
            </div>`;
        });
    },

    updateModalBuildBlocks: () => {
        const count = parseInt(document.getElementById('inputBuildCount').value);
        const container = document.getElementById('modalBuildsContainer');
        while(State.tempChar.builds.length < count) {
            State.tempChar.builds.push({ name: `PLAN ${String.fromCharCode(65+State.tempChar.builds.length)}: (自行修改名称)`, items: {idol:null,manual:null,key:null} });
        }
        while(State.tempChar.builds.length > count) State.tempChar.builds.pop();
        container.innerHTML = '';
        State.tempChar.builds.forEach((build, idx) => {
            const block = document.createElement('div');
            block.className = 'modal-plan-block';
            block.innerHTML = `<input type="text" value="${build.name}" onchange="State.tempChar.builds[${idx}].name=this.value" style="border:none;border-bottom:1px solid #000;font-weight:bold;margin-bottom:10px;">
                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:4px;">A. 偶像</div><div class="chip-grid" id="chip-idol-${idx}"></div>
                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:4px;">B. 图籍</div><div class="chip-grid" id="chip-manual-${idx}"></div>
                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:4px;">C. 钥匙</div><div class="chip-grid" id="chip-key-${idx}"></div>`;
            container.appendChild(block);
            UI.renderChipGroup(idx, '偶像', 'idol', `chip-idol-${idx}`);
            UI.renderChipGroup(idx, '图籍', 'manual', `chip-manual-${idx}`);
            UI.renderChipGroup(idx, '钥匙', 'key', `chip-key-${idx}`);
        });
        UI.refreshAllChipFilters();
    },

    renderChipGroup: (bIdx, cat, type, divId) => {
        const div = document.getElementById(divId);
        DB.anchors[cat].forEach(item => {
            const el = document.createElement('div');
            el.className = 'chip'; el.textContent = item.name; el.dataset.prof = item.prof;
            if(State.tempChar.builds[bIdx].items[type]?.name === item.name) el.classList.add('selected');
            el.onclick = () => {
                State.tempChar.builds[bIdx].items[type] = JSON.parse(JSON.stringify(item));
                Array.from(div.children).forEach(c=>c.classList.remove('selected'));
                el.classList.add('selected');
            };
            div.appendChild(el);
        });
    },

    refreshAllChipFilters: () => {
        const roles = ["突击手", "狙击手", "异能者", "战术员", "刀锋", "盾卫"];
        const p = State.tempChar.tags.find(t => roles.includes(t)) || "ALL";
        document.querySelectorAll('.chip').forEach(c => {
            const match = p === "ALL" || c.dataset.prof === '通用' || c.dataset.prof.includes(p);
            match ? c.classList.remove('dimmed') : c.classList.add('dimmed');
        });
    },

    renderTags: () => {
        const div = document.getElementById('tagsContainer');
        const input = document.getElementById('tagInput');
        Array.from(div.children).forEach(c => { if(c !== input) c.remove(); });
        State.tempChar.tags.forEach((t, i) => {
            const el = document.createElement('div'); el.className = 'tag-chip';
            el.innerHTML = `${t} <span onclick="UI.removeTag(${i})">×</span>`;
            div.insertBefore(el, input);
        });
        UI.refreshAllChipFilters();
    },

    removeTag: (i) => { State.tempChar.tags.splice(i,1); UI.renderTags(); },
    handleTagInput: (e) => {
        if(e.key==='Enter' && e.target.value.trim()){ 
            State.tempChar.tags.push(e.target.value.trim()); e.target.value=''; UI.renderTags(); 
        }
        if(e.key==='Backspace' && !e.target.value && State.tempChar.tags.length) { 
            State.tempChar.tags.pop(); UI.renderTags(); 
        }
    },
    
    updateViewMode: () => {
        const btn = document.querySelector('.btn-calc');
        const rc = document.getElementById('resultContainer');
        if (!State.characters.length) { btn.innerHTML = 'ANALYZE'; btn.style.opacity = '0.5'; rc.classList.remove('active'); return; }
        btn.style.opacity = '1';
        if (State.isBriefingMode) { btn.innerHTML = 'CLOSE BRIEFING'; rc.classList.add('active'); } 
        else { btn.innerHTML = 'ANALYZE'; rc.classList.remove('active'); }
    }
};

const App = {
    openNewFileModal: () => {
        State.tempChar = { name:"", tags:[], filterProf:"ALL", builds:[{name:"PLAN A: (自行修改名称)", items:{idol:null,manual:null,key:null}}] };
        document.getElementById('inputName').value=""; document.getElementById('tagInput').value="";
        UI.renderTags(); UI.updateModalBuildBlocks();
        document.getElementById('editorModal').classList.add('open');
    },
    closeModal: () => document.getElementById('editorModal').classList.remove('open'),
    saveCharacter: () => {
        const name = document.getElementById('inputName').value.trim() || "UNKNOWN";
        State.tempChar.name = name;
        const newChar = JSON.parse(JSON.stringify(State.tempChar));
        newChar.id = Date.now(); State.characters.push(newChar);
        UI.renderFlow(); if(State.isBriefingMode) App.generateReport(true); else UI.updateViewMode();
        App.closeModal();
    },
    deleteChar: (id) => {
        State.characters = State.characters.filter(c=>c.id!==id);
        UI.renderFlow(); if(!State.characters.length) State.isBriefingMode = false;
        if(State.isBriefingMode) App.generateReport(true); else UI.updateViewMode();
    },
    generateReport: (forceRefresh = false) => {
        if(!State.characters.length) return;
        if(!forceRefresh) State.isBriefingMode = !State.isBriefingMode;
        if(State.isBriefingMode) {
            const reportData = {};
            State.characters.forEach(char => char.builds.forEach(build => ['idol','manual','key'].forEach(k => {
                const item = build.items[k];
                if(item) {
                    let src = item.src.replace('获取','');
                    if(!reportData[src]) reportData[src] = [];
                    let existing = reportData[src].find(i => i.name === item.name);
                    existing ? existing.count++ : reportData[src].push({ name: item.name, count: 1 });
                }
            })));
            UI.renderBriefing(reportData);
        }
        UI.updateViewMode();
    },
    openRandModal: (charId, bIdx, type) => {
        const char = State.characters.find(c => c.id === charId);
        const item = char.builds[bIdx].items[type];
        if(!item || !item.random) return;

        document.getElementById('randModalAnchorName').textContent = item.name;
        document.getElementById('randModalFixed').textContent = item.fixed;
        
        const optionsDiv = document.getElementById('randModalOptions');
        optionsDiv.innerHTML = '';
        item.random.forEach(skill => {
            const btn = document.createElement('div'); btn.className = 'mini-btn'; btn.textContent = skill;
            if(item.selectedRand === skill) { btn.style.background = 'var(--ink-black)'; btn.style.color = 'white'; }
            btn.onclick = () => App.selectRandSkill(charId, bIdx, type, skill);
            optionsDiv.appendChild(btn);
        });

        if(item.selectedRand) {
            const clearBtn = document.createElement('div');
            clearBtn.className = 'mini-btn'; clearBtn.style.color = 'var(--retro-red)'; clearBtn.style.borderColor = 'var(--retro-red)';
            clearBtn.textContent = '清除选择'; clearBtn.onclick = () => App.selectRandSkill(charId, bIdx, type, null);
            optionsDiv.appendChild(clearBtn);
        }
        document.getElementById('randSkillModal').classList.add('open');
    },
    selectRandSkill: (charId, bIdx, type, skillStr) => {
        const char = State.characters.find(c => c.id === charId);
        char.builds[bIdx].items[type].selectedRand = skillStr;
        const sy = window.scrollY; UI.renderFlow(); window.scrollTo(0, sy);
        document.getElementById('randSkillModal').classList.remove('open');
    }
};

document.addEventListener('DOMContentLoaded', () => { UI.updateViewMode(); });
</script>
</body>

</html>
